version: 2
jobs:
  has-bottleable-commits:
    steps:
      - run:
        name: Check for new commits that should be built
        command: |
          last_commit="$(git log -1 --pretty=%B | cat)"
          files_to_build=$(git diff --name-status HEAD~1 HEAD | grep '^[AM]' | grep 'Formula' | cut -f2)

          if [[ ${last_commit} == *[BOT]* ]]
          then
            echo "This commit was generated by a bot, skipping."
            exit 1
          fi

          if [[ -z ${files_to_build} ]]
          then
            echo "No files to build, skipping."
            exit 1
          fi

  bottle-mojave:
    macos:
      xcode: "10.3.0"

    steps: &build-steps
      - add_ssh_keys
      - checkout
      - run:
          name: Build and run tests
          command: |
            bash -c .circleci/bottle-new-files.sh

  bottle-high-sierra:
    macos:
      xcode: "10.1.0"

    steps: *build-steps

  bottle-catalina:
    macos:
      xcode: "11.3.0"

    steps: *build-steps

workflows:
  version: 2
  build-bottles:
    jobs:
      - has-bottleable-commits
          filters:
            branches:
              only: master
      - bottle-mojave:
          requires:
            - check-for-bottleable-commits
      - bottle-high-sierra:
          requires:
            - check-for-bottleable-commits
      - bottle-catalina:
          requires:
            - check-for-bottleable-commits
