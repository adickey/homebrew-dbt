version: 2.1
jobs:
  includes-bottleable-commits:
    docker:
      - image: circleci/python
    steps:
      - add_ssh_keys
      - checkout
      - run:
          name: Check for new commits that should be built
          command: |
            last_commit=$(git log -1 --pretty='%B' | cat || echo '')
            files_to_build=$(git diff --name-status 'HEAD~1' 'HEAD' | cat | grep '^[AM]' | cat | grep 'Formula' | cat | cut -f2 || echo '')

            if [[ ${last_commit} == *[BOT]* ]]
            then
              echo "This commit was generated by a bot, skipping." && exit 255
            fi

            if [[ -z ${files_to_build} ]]
            then
              echo "No files to build, skipping." && exit 255
            fi

  bottle-mojave:
    macos:
      xcode: "10.3.0"

    steps: &build-steps
      - add_ssh_keys
      - checkout
      - run:
          name: Build and run tests
          command: |
            bash -c .circleci/bottle-new-files.sh

  bottle-high-sierra:
    macos:
      xcode: "10.1.0"

    steps: *build-steps

  bottle-catalina:
    macos:
      xcode: "11.3.0"

    steps: *build-steps

workflows:
  version: 2.1
  build-bottles:
    jobs:
      - includes-bottleable-commits:
          filters:
            branches:
              only: master
      - bottle-mojave:
          requires:
            - includes-bottleable-commits
      - bottle-high-sierra:
          requires:
            - includes-bottleable-commits
      - bottle-catalina:
          requires:
            - includes-bottleable-commits
